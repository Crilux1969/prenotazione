<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenotazione Campi da Beach-Volley Arzilla - Estate 2025</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: url('sfondo.jpg') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
        }
        h1 {
            text-align: center;
            padding: 20px;
            color: #fff;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(135, 206, 235, 0.8);
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .campi-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            padding: 20px;
        }
        .campo {
            background-color: rgba(135, 206, 235, 0.9);
            border: 2px solid #FFD700;
            padding: 20px;
            width: 150px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, width 0.2s, border 0.2s;
        }
        .campo:hover {
            transform: scale(1.05);
        }
        .campo a {
            text-decoration: none;
            color: #333;
            font-weight: bold;
            display: block;
        }
        .campo-attivo {
            width: 170px;
            border: 3px solid red;
        }
        .content {
            margin-top: 180px;
        }
        .calendario {
            margin: 20px auto;
            width: 90%;
            max-width: 1000px;
            display: none;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            padding: 10px;
        }
        .active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: rgba(255, 255, 240, 0.7);
        }
        th, td {
            border: 1px solid #FFD700;
            padding: 10px;
            text-align: center;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        th {
            background-color: rgba(135, 206, 235, 0.85);
        }
        .prenotazione-inizio {
            color: green;
            font-weight: bold;
        }
        .prenotazione-mezzo {
            color: #87CEEB;
            font-weight: bold;
        }
        .prenotazione-fine {
            color: red;
            font-weight: bold;
        }
        .cancella {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 5px;
            cursor: pointer;
            border-radius: 5px;
            display: block; /* Rende il pulsante un elemento a blocco per andare a capo */
            margin: 5px auto 0; /* Centra il pulsante e aggiunge spazio sopra */
        }
        .form-prenotazione {
            text-align: center;
            margin: 20px;
        }
        .form-prenotazione input, .form-prenotazione select, .form-prenotazione button {
            margin: 5px;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #FFD700;
            background-color: rgba(255, 255, 255, 0.7);
        }
        .form-prenotazione button {
            background-color: rgba(135, 206, 235, 0.9);
            cursor: pointer;
        }
        #importa-file {
            display: none;
        }
    </style>
</head>
<body>

    <!-- Homepage -->
    <div id="homepage">
        <div class="header">
            <h1>Prenotazione Campi da Beach-Volley Arzilla - Estate 2025</h1>
            <div class="campi-container">
                <div class="campo" id="btn-campo1"><a onclick="mostraCalendario('campo1')">Campo 1</a></div>
                <div class="campo" id="btn-campo2"><a onclick="mostraCalendario('campo2')">Campo 2</a></div>
                <div class="campo" id="btn-campo3"><a onclick="mostraCalendario('campo3')">Campo 3</a></div>
                <div class="campo" id="btn-campo4"><a onclick="mostraCalendario('campo4')">Campo 4</a></div>
                <div class="campo" id="btn-campo5"><a onclick="mostraCalendario('campo5')">Campo 5</a></div>
            </div>
        </div>
        <div class="content">
            <!-- Calendario Campo 1 -->
            <div id="campo1" class="calendario active">
                <div class="form-prenotazione">
                    <input type="text" id="nome1" placeholder="Prenotazione a nome di:" required>
                    <select id="giorno1">
                        <option value="">Giorno</option>
                        <option value="1">Lunedì</option>
                        <option value="2">Martedì</option>
                        <option value="3">Mercoledì</option>
                        <option value="4">Giovedì</option>
                        <option value="5">Venerdì</option>
                        <option value="6">Sabato</option>
                        <option value="7">Domenica</option>
                    </select>
                    <select id="ora-inizio1">
                        <option value="">Ora di inizio</option>
                    </select>
                    <select id="ora-fine1">
                        <option value="">Ora di fine</option>
                    </select>
                    <button onclick="aggiungiPrenotazione('campo1')">Prenota</button>
                    <br>
                    <input type="file" id="importa-file1" accept=".csv" onchange="importaCSV(event)">
                    <button onclick="document.getElementById('importa-file1').click()">Carica Prenotazioni</button>
                </div>
                <table id="tabella-campo1">
                    <tr id="header-row-campo1">
                        <th>Orario</th>
                        <!-- I giorni con data verranno aggiunti dinamicamente -->
                    </tr>
                </table>
            </div>

            <!-- Calendario Campo 2 -->
            <div id="campo2" class="calendario">
                <div class="form-prenotazione">
                    <input type="text" id="nome2" placeholder="Prenotazione a nome di:" required>
                    <select id="giorno2">
                        <option value="">Giorno</option>
                        <option value="1">Lunedì</option>
                        <option value="2">Martedì</option>
                        <option value="3">Mercoledì</option>
                        <option value="4">Giovedì</option>
                        <option value="5">Venerdì</option>
                        <option value="6">Sabato</option>
                        <option value="7">Domenica</option>
                    </select>
                    <select id="ora-inizio2">
                        <option value="">Ora di inizio</option>
                    </select>
                    <select id="ora-fine2">
                        <option value="">Ora di fine</option>
                    </select>
                    <button onclick="aggiungiPrenotazione('campo2')">Prenota</button>
                    <br>
                    <input type="file" id="importa-file2" accept=".csv" onchange="importaCSV(event)">
                    <button onclick="document.getElementById('importa-file2').click()">Carica Prenotazioni</button>
                </div>
                <table id="tabella-campo2">
                    <tr id="header-row-campo2">
                        <th>Orario</th>
                        <!-- I giorni con data verranno aggiunti dinamicamente -->
                    </tr>
                </table>
            </div>

            <!-- Calendario Campo 3 -->
            <div id="campo3" class="calendario">
                <div class="form-prenotazione">
                    <input type="text" id="nome3" placeholder="Prenotazione a nome di:" required>
                    <select id="giorno3">
                        <option value="">Giorno</option>
                        <option value="1">Lunedì</option>
                        <option value="2">Martedì</option>
                        <option value="3">Mercoledì</option>
                        <option value="4">Giovedì</option>
                        <option value="5">Venerdì</option>
                        <option value="6">Sabato</option>
                        <option value="7">Domenica</option>
                    </select>
                    <select id="ora-inizio3">
                        <option value="">Ora di inizio</option>
                    </select>
                    <select id="ora-fine3">
                        <option value="">Ora di fine</option>
                    </select>
                    <button onclick="aggiungiPrenotazione('campo3')">Prenota</button>
                    <br>
                    <input type="file" id="importa-file3" accept=".csv" onchange="importaCSV(event)">
                    <button onclick="document.getElementById('importa-file3').click()">Carica Prenotazioni</button>
                </div>
                <table id="tabella-campo3">
                    <tr id="header-row-campo3">
                        <th>Orario</th>
                        <!-- I giorni con data verranno aggiunti dinamicamente -->
                    </tr>
                </table>
            </div>

            <!-- Calendario Campo 4 -->
            <div id="campo4" class="calendario">
                <div class="form-prenotazione">
                    <input type="text" id="nome4" placeholder="Prenotazione a nome di:" required>
                    <select id="giorno4">
                        <option value="">Giorno</option>
                        <option value="1">Lunedì</option>
                        <option value="2">Martedì</option>
                        <option value="3">Mercoledì</option>
                        <option value="4">Giovedì</option>
                        <option value="5">Venerdì</option>
                        <option value="6">Sabato</option>
                        <option value="7">Domenica</option>
                    </select>
                    <select id="ora-inizio4">
                        <option value="">Ora di inizio</option>
                    </select>
                    <select id="ora-fine4">
                        <option value="">Ora di fine</option>
                    </select>
                    <button onclick="aggiungiPrenotazione('campo4')">Prenota</button>
                    <br>
                    <input type="file" id="importa-file4" accept=".csv" onchange="importaCSV(event)">
                    <button onclick="document.getElementById('importa-file4').click()">Carica Prenotazioni</button>
                </div>
                <table id="tabella-campo4">
                    <tr id="header-row-campo4">
                        <th>Orario</th>
                        <!-- I giorni con data verranno aggiunti dinamicamente -->
                    </tr>
                </table>
            </div>

            <!-- Calendario Campo 5 -->
            <div id="campo5" class="calendario">
                <div class="form-prenotazione">
                    <input type="text" id="nome5" placeholder="Prenotazione a nome di:" required>
                    <select id="giorno5">
                        <option value="">Giorno</option>
                        <option value="1">Lunedì</option>
                        <option value="2">Martedì</option>
                        <option value="3">Mercoledì</option>
                        <option value="4">Giovedì</option>
                        <option value="5">Venerdì</option>
                        <option value="6">Sabato</option>
                        <option value="7">Domenica</option>
                    </select>
                    <select id="ora-inizio5">
                        <option value="">Ora di inizio</option>
                    </select>
                    <select id="ora-fine5">
                        <option value="">Ora di fine</option>
                    </select>
                    <button onclick="aggiungiPrenotazione('campo5')">Prenota</button>
                    <br>
                    <input type="file" id="importa-file5" accept=".csv" onchange="importaCSV(event)">
                    <button onclick="document.getElementById('importa-file5').click()">Carica Prenotazioni</button>
                </div>
                <table id="tabella-campo5">
                    <tr id="header-row-campo5">
                        <th>Orario</th>
                        <!-- I giorni con data verranno aggiunti dinamicamente -->
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Orari disponibili (8:00 - 24:00, intervalli di 30 minuti)
        const orari = [];
        for (let h = 8; h <= 23; h++) {
            orari.push(`${h}:00`);
            orari.push(`${h}:30`);
        }
        orari.push("24:00");

        // Nomi dei giorni della settimana
        const giorniSettimana = ["Lunedì", "Martedì", "Mercoledì", "Giovedì", "Venerdì", "Sabato", "Domenica"];

        // Funzione per ottenere i giorni della settimana corrente con date
        function getCurrentWeekDays() {
            const today = new Date('2025-02-25'); // Data corrente fissa al 25 febbraio 2025
            const currentDay = today.getDay(); // 0 = Domenica, 1 = Lunedì, ecc. (oggi è Martedì = 2)
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - (currentDay === 0 ? 6 : currentDay - 1)); // Inizio settimana (Lunedì)

            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                const dayNumber = day.getDate();
                const monthNumber = day.getMonth() + 1; // Mese parte da 0, quindi +1
                weekDays.push(`${dayNumber}/${monthNumber} ${giorniSettimana[i]}`);
            }
            return weekDays;
        }

        // Inizializza tutte le tabelle con i giorni correnti
        const campi = ['campo1', 'campo2', 'campo3', 'campo4', 'campo5'];
        const weekDays = getCurrentWeekDays();

        campi.forEach(campo => {
            const tabella = document.getElementById(`tabella-${campo}`);
            const headerRow = document.getElementById(`header-row-${campo}`);
            
            // Aggiungi i giorni con date all'intestazione
            weekDays.forEach(day => {
                const th = document.createElement('th');
                th.textContent = day;
                headerRow.appendChild(th);
            });

            // Popola il corpo della tabella con gli orari
            orari.forEach(orario => {
                const row = tabella.insertRow();
                row.insertCell().textContent = orario;
                for (let i = 0; i < 7; i++) row.insertCell();
            });

            // Popola select ora-inizio
            const oraInizioSelect = document.getElementById(`ora-inizio${campo.slice(-1)}`);
            orari.forEach(orario => {
                const option = document.createElement("option");
                option.value = orario;
                option.textContent = orario;
                oraInizioSelect.appendChild(option);
            });

            // Gestione dinamica ora-fine
            oraInizioSelect.addEventListener("change", () => {
                const oraFineSelect = document.getElementById(`ora-fine${campo.slice(-1)}`);
                oraFineSelect.innerHTML = '<option value="">Ora di fine</option>';
                const inizio = oraInizioSelect.value;
                if (inizio) {
                    const indexInizio = orari.indexOf(inizio);
                    for (let i = indexInizio + 2; i < orari.length; i++) {
                        const option = document.createElement("option");
                        option.value = orari[i];
                        option.textContent = orari[i];
                        oraFineSelect.appendChild(option);
                    }
                }
            });
        });

        // Carica prenotazioni da localStorage per ogni campo
        let prenotazioni = {};
        campi.forEach(campo => {
            prenotazioni[campo] = JSON.parse(localStorage.getItem(`prenotazioni${campo.charAt(0).toUpperCase() + campo.slice(1)}`)) || [];
            aggiornaCalendario(campo);
        });

        // Mostra il calendario selezionato e evidenzia il pulsante
        function mostraCalendario(campo) {
            campi.forEach(c => {
                const calendario = document.getElementById(c);
                const pulsante = document.getElementById(`btn-${c}`);
                if (c === campo) {
                    calendario.classList.add('active');
                    pulsante.classList.add('campo-attivo');
                    const headerHeight = document.querySelector('.header').offsetHeight;
                    const offset = calendario.getBoundingClientRect().top + window.pageYOffset - headerHeight;
                    window.scrollTo({ top: offset, behavior: 'smooth' });
                } else {
                    calendario.classList.remove('active');
                    pulsante.classList.remove('campo-attivo');
                }
            });
        }

        // Aggiungi prenotazione
        function aggiungiPrenotazione(campo) {
            const nome = document.getElementById(`nome${campo.slice(-1)}`).value.trim();
            const giorno = parseInt(document.getElementById(`giorno${campo.slice(-1)}`).value);
            const oraInizio = document.getElementById(`ora-inizio${campo.slice(-1)}`).value;
            const oraFine = document.getElementById(`ora-fine${campo.slice(-1)}`).value;

            if (!nome || !giorno || !oraInizio || !oraFine) {
                alert("Inserisci tutti i dati!");
                return;
            }

            const indexInizio = orari.indexOf(oraInizio);
            const indexFine = orari.indexOf(oraFine);

            // Controlla conflitti (tollera sovrapposizione solo all'orario di fine)
            for (let i = indexInizio; i < indexFine; i++) {
                const slotOccupato = prenotazioni[campo].some(p => p.giorno === giorno && p.index === i && !p.fine);
                if (slotOccupato) {
                    alert("Orario già prenotato!");
                    return;
                }
            }

            // Aggiungi prenotazione
            for (let i = indexInizio; i <= indexFine; i++) {
                prenotazioni[campo].push({ giorno: giorno, index: i, nome: nome, inizio: i === indexInizio, fine: i === indexFine });
            }
            localStorage.setItem(`prenotazioni${campo.charAt(0).toUpperCase() + campo.slice(1)}`, JSON.stringify(prenotazioni[campo]));
            aggiornaCalendario(campo);
            esportaTuttiCSV();
            document.getElementById(`nome${campo.slice(-1)}`).value = "";
            document.getElementById(`giorno${campo.slice(-1)}`).value = "";
            document.getElementById(`ora-inizio${campo.slice(-1)}`).value = "";
            document.getElementById(`ora-fine${campo.slice(-1)}`).value = "";
        }

        // Aggiorna il calendario
        function aggiornaCalendario(campo) {
            const tabella = document.getElementById(`tabella-${campo}`);
            for (let i = 1; i < tabella.rows.length; i++) {
                for (let j = 1; j < tabella.rows[i].cells.length; j++) {
                    tabella.rows[i].cells[j].innerHTML = "";
                }
            }

            prenotazioni[campo].forEach(p => {
                const cell = tabella.rows[p.index + 1].cells[p.giorno];
                const ora = orari[p.index];
                let classe = p.inizio ? "prenotazione-inizio" : p.fine ? "prenotazione-fine" : "prenotazione-mezzo";
                let content = `<span class="${classe}">${p.nome}</span><br><button class="cancella" onclick="cancellaPrenotazione('${p.nome}', ${p.giorno}, '${campo}')">Cancella</button>`;

                const prevEnd = prenotazioni[campo].find(pr => pr.giorno === p.giorno && pr.index === p.index && pr.fine && pr.nome !== p.nome);
                const nextStart = prenotazioni[campo].find(pr => pr.giorno === p.giorno && pr.index === p.index && pr.inizio && pr.nome !== p.nome);

                if (prevEnd && nextStart) {
                    cell.innerHTML = `<span class="prenotazione-fine">${prevEnd.nome}</span> - ${ora} - <span class="prenotazione-inizio">${nextStart.nome}</span><br>` +
                        `<button class="cancella" onclick="cancellaPrenotazione('${prevEnd.nome}', ${p.giorno}, '${campo}')">Cancella ${prevEnd.nome}</button><br>` +
                        `<button class="cancella" onclick="cancellaPrenotazione('${nextStart.nome}', ${p.giorno}, '${campo}')">Cancella ${nextStart.nome}</button>`;
                } else if (prevEnd && p.inizio) {
                    cell.innerHTML = `<span class="prenotazione-fine">${prevEnd.nome}</span> - ${ora} - <span class="prenotazione-inizio">${p.nome}</span><br>` +
                        `<button class="cancella" onclick="cancellaPrenotazione('${prevEnd.nome}', ${p.giorno}, '${campo}')">Cancella ${prevEnd.nome}</button><br>` +
                        `<button class="cancella" onclick="cancellaPrenotazione('${p.nome}', ${p.giorno}, '${campo}')">Cancella ${p.nome}</button>`;
                } else if (nextStart && p.fine) {
                    cell.innerHTML = `<span class="prenotazione-fine">${p.nome}</span> - ${ora} - <span class="prenotazione-inizio">${nextStart.nome}</span><br>` +
                        `<button class="cancella" onclick="cancellaPrenotazione('${p.nome}', ${p.giorno}, '${campo}')">Cancella ${p.nome}</button><br>` +
                        `<button class="cancella" onclick="cancellaPrenotazione('${nextStart.nome}', ${p.giorno}, '${campo}')">Cancella ${nextStart.nome}</button>`;
                } else if (!cell.innerHTML) {
                    cell.innerHTML = content;
                }
            });
        }

        // Cancella prenotazione
        function cancellaPrenotazione(nome, giorno, campo) {
            prenotazioni[campo] = prenotazioni[campo].filter(p => !(p.giorno === giorno && p.nome === nome));
            localStorage.setItem(`prenotazioni${campo.charAt(0).toUpperCase() + campo.slice(1)}`, JSON.stringify(prenotazioni[campo]));
            aggiornaCalendario(campo);
            esportaTuttiCSV();
        }

        // Esporta tutte le prenotazioni in un unico CSV
        function esportaTuttiCSV() {
            const csvRows = ["Campo,Giorno,Orario,Nome,Inizio,Fine"];
            campi.forEach(campo => {
                prenotazioni[campo].forEach(p => {
                    csvRows.push(`${campo},${p.giorno},${orari[p.index]},${p.nome},${p.inizio},${p.fine}`);
                });
            });
            const csvContent = "data:text/csv;charset=utf-8," + csvRows.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "prenotazioni.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Importa prenotazioni da CSV per tutti i campi
        function importaCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.split("\n").map(row => row.split(","));

                // Reset delle prenotazioni
                campi.forEach(campo => prenotazioni[campo] = []);

                // Carica i dati dal CSV
                for (let i = 1; i < rows.length; i++) {
                    const [campo, giorno, orario, nome, inizio, fine] = rows[i];
                    if (campo && giorno && orario && nome && campi.includes(campo)) {
                        const index = orari.indexOf(orario.trim());
                        if (index !== -1) {
                            prenotazioni[campo].push({
                                giorno: parseInt(giorno),
                                index: index,
                                nome: nome.trim(),
                                inizio: inizio === "true",
                                fine: fine === "true" || fine.trim() === "true"
                            });
                        }
                    }
                }

                // Aggiorna localStorage e calendari
                campi.forEach(campo => {
                    localStorage.setItem(`prenotazioni${campo.charAt(0).toUpperCase() + campo.slice(1)}`, JSON.stringify(prenotazioni[campo]));
                    aggiornaCalendario(campo);
                });
            };
            reader.readAsText(file);
        }

        // Salva automaticamente alla chiusura della pagina
        window.addEventListener("beforeunload", function() {
            esportaTuttiCSV();
        });

        // Mostra Campo 1 all'avvio e evidenzia il pulsante
        mostraCalendario('campo1');
        document.getElementById('btn-campo1').classList.add('campo-attivo');
    </script>
</body>
</html>