<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenotazione Campi da Beach-Volley Arzilla - Estate 2025</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: url('sfondo.jpg') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
        }
        h1 {
            text-align: center;
            padding: 15px;
            color: #fff;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            font-size: 1.5em;
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(135, 206, 235, 0.8);
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .campi-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            padding: 10px;
        }
        .campo {
            background-color: rgba(135, 206, 235, 0.9);
            border: 2px solid #FFD700;
            padding: 15px;
            width: 120px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, width 0.2s, border 0.2s;
        }
        .campo:hover {
            transform: scale(1.05);
        }
        .campo a {
            text-decoration: none;
            color: #333;
            font-weight: bold;
            display: block;
            font-size: 1em;
        }
        .campo-attivo {
            width: 130px;
            border: 3px solid red;
        }
        .content {
            margin-top: 140px;
        }
        .calendario {
            margin: 15px auto;
            width: 95%;
            max-width: 1000px;
            display: none;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            padding: 10px;
        }
        .active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: rgba(255, 255, 240, 0.7);
            user-select: none;
        }
        th, td {
            border: 1px solid #FFD700;
            padding: 8px;
            text-align: center;
            font-size: 0.9em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            cursor: pointer;
        }
        th {
            background-color: rgba(135, 206, 235, 0.85);
        }
        .prenotazione-inizio {
            color: green;
            font-weight: bold;
        }
        .prenotazione-mezzo {
            color: #87CEEB;
            font-weight: bold;
        }
        .prenotazione-fine {
            color: red;
            font-weight: bold;
        }
        .cancella {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 6px;
            cursor: pointer;
            border-radius: 5px;
            display: block;
            margin: 5px auto;
            font-size: 0.9em;
        }
        .form-prenotazione {
            text-align: center;
            margin: 15px;
        }
        .form-prenotazione input, .form-prenotazione button {
            margin: 5px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #FFD700;
            background-color: rgba(255, 255, 255, 0.7);
            font-size: 1em;
            width: 90%;
            max-width: 300px;
        }
        .form-prenotazione button {
            background-color: rgba(135, 206, 235, 0.9);
            cursor: pointer;
        }
        #importa-file {
            display: none;
        }
        .faccina {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            padding: 0;
            margin-top: 5px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .slot-libero {
            border: 2px solid #00FF00;
        }
        .slot-prenotato {
            border: 2px solid #FF0000;
        }
        .slot-selezionato {
            background-color: rgba(255, 215, 0, 0.5);
        }

        /* Media Queries per Tablet */
        @media (max-width: 1024px) and (min-width: 600px) {
            h1 { font-size: 1.3em; padding: 10px; }
            .header { padding-bottom: 5px; }
            .campi-container { gap: 8px; padding: 8px; }
            .campo { width: 100px; padding: 10px; }
            .campo-attivo { width: 110px; }
            .content { margin-top: 120px; }
            .calendario { width: 98%; padding: 8px; }
            th, td { padding: 6px; font-size: 0.85em; }
            .form-prenotazione input, .form-prenotazione button { padding: 8px; font-size: 0.95em; width: 85%; }
            .cancella { padding: 5px; font-size: 0.85em; }
            .faccina { font-size: 1.1em; }
        }

        /* Media Queries per Smartphone */
        @media (max-width: 599px) {
            h1 { font-size: 1.1em; padding: 8px; }
            .campi-container { flex-direction: column; align-items: center; gap: 5px; }
            .campo { width: 80%; padding: 8px; }
            .campo-attivo { width: 85%; }
            .content { margin-top: 100px; }
            .calendario { width: 100%; padding: 5px; }
            th, td { padding: 4px; font-size: 0.75em; }
            .form-prenotazione input, .form-prenotazione button { padding: 6px; font-size: 0.9em; width: 95%; }
            .cancella { padding: 4px; font-size: 0.8em; }
            .faccina { font-size: 1em; }
        }
    </style>
</head>
<body>

    <!-- Homepage -->
    <div id="homepage">
        <div class="header">
            <h1>Prenotazione Campi da Beach-Volley Arzilla - Estate 2025</h1>
            <div class="campi-container">
                <div class="campo" id="btn-campo1"><a onclick="mostraCalendario('campo1')">Campo 1</a></div>
                <div class="campo" id="btn-campo2"><a onclick="mostraCalendario('campo2')">Campo 2</a></div>
                <div class="campo" id="btn-campo3"><a onclick="mostraCalendario('campo3')">Campo 3</a></div>
                <div class="campo" id="btn-campo4"><a onclick="mostraCalendario('campo4')">Campo 4</a></div>
                <div class="campo" id="btn-campo5"><a onclick="mostraCalendario('campo5')">Campo 5</a></div>
            </div>
        </div>
        <div class="content">
            <!-- Calendario Campo 1 -->
            <div id="campo1" class="calendario active">
                <div class="form-prenotazione">
                    <input type="text" id="nome1" placeholder="Inserisci il nome (es. Lucio)">
                    <br>
                    <input type="file" id="importa-file1" accept=".csv" onchange="importaCSV(event)">
                    <button onclick="document.getElementById('importa-file1').click()">Carica Prenotazioni</button>
                </div>
                <table id="tabella-campo1">
                    <tr id="header-row-campo1">
                        <th>Orario</th>
                    </tr>
                </table>
            </div>

            <!-- Calendario Campo 2 -->
            <div id="campo2" class="calendario">
                <div class="form-prenotazione">
                    <input type="text" id="nome2" placeholder="Inserisci il nome (es. Lucio)">
                    <br>
                    <input type="file" id="importa-file2" accept=".csv" onchange="importaCSV(event)">
                    <button onclick="document.getElementById('importa-file2').click()">Carica Prenotazioni</button>
                </div>
                <table id="tabella-campo2">
                    <tr id="header-row-campo2">
                        <th>Orario</th>
                    </tr>
                </table>
            </div>

            <!-- Calendario Campo 3 -->
            <div id="campo3" class="calendario">
                <div class="form-prenotazione">
                    <input type="text" id="nome3" placeholder="Inserisci il nome (es. Lucio)">
                    <br>
                    <input type="file" id="importa-file3" accept=".csv" onchange="importaCSV(event)">
                    <button onclick="document.getElementById('importa-file3').click()">Carica Prenotazioni</button>
                </div>
                <table id="tabella-campo3">
                    <tr id="header-row-campo3">
                        <th>Orario</th>
                    </tr>
                </table>
            </div>

            <!-- Calendario Campo 4 -->
            <div id="campo4" class="calendario">
                <div class="form-prenotazione">
                    <input type="text" id="nome4" placeholder="Inserisci il nome (es. Lucio)">
                    <br>
                    <input type="file" id="importa-file4" accept=".csv" onchange="importaCSV(event)">
                    <button onclick="document.getElementById('importa-file4').click()">Carica Prenotazioni</button>
                </div>
                <table id="tabella-campo4">
                    <tr id="header-row-campo4">
                        <th>Orario</th>
                    </tr>
                </table>
            </div>

            <!-- Calendario Campo 5 -->
            <div id="campo5" class="calendario">
                <div class="form-prenotazione">
                    <input type="text" id="nome5" placeholder="Inserisci il nome (es. Lucio)">
                    <br>
                    <input type="file" id="importa-file5" accept=".csv" onchange="importaCSV(event)">
                    <button onclick="document.getElementById('importa-file5').click()">Carica Prenotazioni</button>
                </div>
                <table id="tabella-campo5">
                    <tr id="header-row-campo5">
                        <th>Orario</th>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Orari disponibili (8:00 - 24:00, intervalli di 30 minuti)
        const orari = [];
        for (let h = 8; h <= 23; h++) {
            orari.push(`${h}:00`);
            orari.push(`${h}:30`);
        }
        orari.push("24:00");

        // Nomi dei giorni della settimana
        const giorniSettimana = ["Lunedì", "Martedì", "Mercoledì", "Giovedì", "Venerdì", "Sabato", "Domenica"];

        // Funzione per ottenere i giorni della settimana a partire dal giorno corrente
        function getCurrentWeekDays() {
            const today = new Date();
            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const day = new Date(today);
                day.setDate(today.getDate() + i);
                const dayNumber = day.getDate();
                const monthNumber = day.getMonth() + 1;
                const dayOfWeek = giorniSettimana[day.getDay() === 0 ? 6 : day.getDay() - 1];
                weekDays.push(`${dayNumber}/${monthNumber} ${dayOfWeek}`);
            }
            return weekDays;
        }

        // Inizializza tabelle e variabili
        const campi = ['campo1', 'campo2', 'campo3', 'campo4', 'campo5'];
        const weekDays = getCurrentWeekDays();
        let prenotazioni = {};
        let isDragging = false;
        let startCell = null;
        let endCell = null;
        let currentCampo = 'campo1';
        let selectedNome = null; // Variabile per memorizzare il nome inserito con prompt

        campi.forEach(campo => {
            const tabella = document.getElementById(`tabella-${campo}`);
            const headerRow = document.getElementById(`header-row-${campo}`);
            
            weekDays.forEach(day => {
                const th = document.createElement('th');
                th.textContent = day;
                headerRow.appendChild(th);
            });

            orari.forEach((orario, index) => {
                const row = tabella.insertRow();
                row.insertCell().textContent = orario;
                for (let i = 0; i < 7; i++) {
                    const cell = row.insertCell();
                    cell.dataset.giorno = i + 1;
                    cell.dataset.index = index;
                }
            });

            prenotazioni[campo] = JSON.parse(localStorage.getItem(`prenotazioni${campo.charAt(0).toUpperCase() + campo.slice(1)}`)) || [];
            aggiornaCalendario(campo);

            // Gestione eventi del mouse sulla tabella
            tabella.addEventListener('mousedown', (e) => {
                const cell = e.target.closest('td');
                if (!cell || cell.cellIndex === 0) return; // Ignora la colonna degli orari
                selectedNome = prompt("Inserisci il nome per la prenotazione (es. Lucio):");
                if (!selectedNome || selectedNome.trim() === "") {
                    alert("Devi inserire un nome per prenotare!");
                    return;
                }
                console.log(`Nome inserito: ${selectedNome}`); // Debug
                isDragging = true;
                startCell = cell;
                endCell = null;
                cell.classList.add('slot-selezionato');
            });

            tabella.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const cell = e.target.closest('td');
                if (!cell || cell.cellIndex === 0 || cell.dataset.giorno !== startCell.dataset.giorno) return;
                endCell = cell;

                // Rimuovi selezione precedente
                const rows = tabella.rows;
                for (let i = 1; i < rows.length; i++) {
                    const currentCell = rows[i].cells[startCell.cellIndex];
                    currentCell.classList.remove('slot-selezionato');
                }

                // Evidenzia la selezione corrente
                const startIndex = Math.min(parseInt(startCell.dataset.index), parseInt(endCell.dataset.index));
                const endIndex = Math.max(parseInt(startCell.dataset.index), parseInt(endCell.dataset.index));
                for (let i = startIndex; i <= endIndex; i++) {
                    const currentCell = rows[i + 1].cells[startCell.cellIndex];
                    if (!currentCell.classList.contains('slot-prenotato')) {
                        currentCell.classList.add('slot-selezionato');
                    }
                }
            });

            tabella.addEventListener('mouseup', (e) => {
                if (!isDragging || !startCell || !endCell || !selectedNome) {
                    isDragging = false;
                    startCell = null;
                    endCell = null;
                    selectedNome = null;
                    aggiornaCalendario(campo);
                    return;
                }
                isDragging = false;

                const giorno = parseInt(startCell.dataset.giorno);
                const startIndex = Math.min(parseInt(startCell.dataset.index), parseInt(endCell.dataset.index));
                const endIndex = Math.max(parseInt(startCell.dataset.index), parseInt(endCell.dataset.index));

                // Verifica conflitti, permettendo l'inizio dall'ultimo slot prenotato
                for (let i = startIndex; i <= endIndex; i++) {
                    const slot = prenotazioni[campo].find(p => p.giorno === giorno && p.index === i);
                    if (slot && !(slot.fine && i === startIndex)) {
                        alert("Uno o più slot selezionati sono già prenotati!");
                        aggiornaCalendario(campo);
                        startCell = null;
                        endCell = null;
                        selectedNome = null;
                        return;
                    }
                }

                // Aggiungi prenotazione
                const idPrenotazione = Date.now() + Math.random().toString(36).substr(2, 9);
                console.log(`Aggiungo prenotazione: Nome=${selectedNome}, Giorno=${giorno}, Da=${orari[startIndex]}, A=${orari[endIndex]}`); // Debug
                for (let i = startIndex; i <= endIndex; i++) {
                    prenotazioni[campo].push({
                        id: idPrenotazione,
                        giorno: giorno,
                        index: i,
                        nome: selectedNome.trim(),
                        inizio: i === startIndex,
                        fine: i === endIndex,
                        spunta: false
                    });
                }

                localStorage.setItem(`prenotazioni${campo.charAt(0).toUpperCase() + campo.slice(1)}`, JSON.stringify(prenotazioni[campo]));
                aggiornaCalendario(campo);
                esportaTuttiCSV();
                startCell = null;
                endCell = null;
                selectedNome = null;
            });

            tabella.addEventListener('mouseleave', () => {
                if (isDragging) {
                    isDragging = false;
                    aggiornaCalendario(campo);
                    startCell = null;
                    endCell = null;
                    selectedNome = null;
                }
            });
        });

        // Mostra il calendario selezionato
        function mostraCalendario(campo) {
            currentCampo = campo;
            campi.forEach(c => {
                const calendario = document.getElementById(c);
                const pulsante = document.getElementById(`btn-${c}`);
                if (c === campo) {
                    calendario.classList.add('active');
                    pulsante.classList.add('campo-attivo');
                    const headerHeight = document.querySelector('.header').offsetHeight;
                    const offset = calendario.getBoundingClientRect().top + window.pageYOffset - headerHeight;
                    window.scrollTo({ top: offset, behavior: 'smooth' });
                } else {
                    calendario.classList.remove('active');
                    pulsante.classList.remove('campo-attivo');
                }
            });
        }

        // Aggiorna il calendario
        function aggiornaCalendario(campo) {
            const tabella = document.getElementById(`tabella-${campo}`);
            for (let i = 1; i < tabella.rows.length; i++) {
                for (let j = 1; j < tabella.rows[i].cells.length; j++) {
                    tabella.rows[i].cells[j].className = 'slot-libero';
                    tabella.rows[i].cells[j].innerHTML = "";
                }
            }

            prenotazioni[campo].forEach(p => {
                const cell = tabella.rows[p.index + 1].cells[p.giorno];
                cell.className = 'slot-prenotato';
                const ora = orari[p.index];
                let classe = p.inizio ? "prenotazione-inizio" : p.fine ? "prenotazione-fine" : "prenotazione-mezzo";
                let content = `<span class="${classe}">${p.nome}</span>`;
                
                const prevEnd = prenotazioni[campo].find(pr => pr.giorno === p.giorno && pr.index === p.index && pr.fine && pr.nome !== p.nome);
                const nextStart = prenotazioni[campo].find(pr => pr.giorno === p.giorno && pr.index === p.index && pr.inizio && pr.nome !== p.nome);

                if (prevEnd && p.inizio) {
                    content = `<span class="prenotazione-fine">${prevEnd.nome}</span>` +
                              `<br><button class="cancella" onclick="cancellaPrenotazione('${prevEnd.id}', '${campo}')">Cancella ${prevEnd.nome}</button>` +
                              `<br>${ora}` +
                              `<br><span class="prenotazione-inizio">${p.nome}</span>` +
                              `<br><button class="cancella" onclick="cancellaPrenotazione('${p.id}', '${campo}')">Cancella ${p.nome}</button>` +
                              `<br><button class="faccina" onclick="cambiaSpunta('${p.id}', '${campo}')">${p.spunta ? '✓' : '○'}</button>`;
                } else if (nextStart && p.fine) {
                    content = `<span class="prenotazione-fine">${p.nome}</span>` +
                              `<br><button class="cancella" onclick="cancellaPrenotazione('${p.id}', '${campo}')">Cancella ${p.nome}</button>` +
                              `<br>${ora}` +
                              `<br><span class="prenotazione-inizio">${nextStart.nome}</span>` +
                              `<br><button class="cancella" onclick="cancellaPrenotazione('${nextStart.id}', '${campo}')">Cancella ${nextStart.nome}</button>` +
                              `<br><button class="faccina" onclick="cambiaSpunta('${nextStart.id}', '${campo}')">${nextStart.spunta ? '✓' : '○'}</button>`;
                } else {
                    if (p.inizio) {
                        content += `<br><button class="cancella" onclick="cancellaPrenotazione('${p.id}', '${campo}')">Cancella</button>` +
                                   `<br><button class="faccina" onclick="cambiaSpunta('${p.id}', '${campo}')">${p.spunta ? '✓' : '○'}</button>`;
                    }
                }

                cell.innerHTML = content;
            });
        }

        // Funzione per cambiare il simbolo in spunta
        function cambiaSpunta(id, campo) {
            prenotazioni[campo].forEach(p => {
                if (p.id === id && p.inizio) {
                    p.spunta = true;
                }
            });
            localStorage.setItem(`prenotazioni${campo.charAt(0).toUpperCase() + campo.slice(1)}`, JSON.stringify(prenotazioni[campo]));
            aggiornaCalendario(campo);
            esportaTuttiCSV();
        }

        // Cancella prenotazione specifica
        function cancellaPrenotazione(id, campo) {
            prenotazioni[campo] = prenotazioni[campo].filter(p => p.id !== id);
            localStorage.setItem(`prenotazioni${campo.charAt(0).toUpperCase() + campo.slice(1)}`, JSON.stringify(prenotazioni[campo]));
            aggiornaCalendario(campo);
            esportaTuttiCSV();
        }

        // Esporta tutte le prenotazioni in un unico CSV
        function esportaTuttiCSV() {
            const csvRows = ["Campo,Giorno,Orario,Nome,Inizio,Fine,Spunta,ID"];
            campi.forEach(campo => {
                prenotazioni[campo].forEach(p => {
                    csvRows.push(`${campo},${p.giorno},${orari[p.index]},${p.nome},${p.inizio},${p.fine},${p.spunta},${p.id}`);
                });
            });
            const csvContent = "data:text/csv;charset=utf-8," + csvRows.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "prenotazioni.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Importa prenotazioni da CSV per tutti i campi
        function importaCSV(event) {
            const file = event.target.files[0];
            if (!file) {
                alert("Nessun file selezionato!");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.split("\n").map(row => row.split(","));

                campi.forEach(campo => prenotazioni[campo] = []);

                for (let i = 1; i < rows.length; i++) {
                    const [csvCampo, giorno, orario, nome, inizio, fine, spunta, id] = rows[i];
                    if (csvCampo && giorno && orario && nome && campi.includes(csvCampo.trim())) {
                        const index = orari.indexOf(orario.trim());
                        if (index !== -1) {
                            prenotazioni[csvCampo.trim()].push({
                                id: id || (Date.now() + Math.random().toString(36).substr(2, 9)),
                                giorno: parseInt(giorno),
                                index: index,
                                nome: nome.trim(),
                                inizio: inizio === "true",
                                fine: fine === "true" || fine.trim() === "true",
                                spunta: spunta === "true" || spunta.trim() === "true"
                            });
                        }
                    }
                }

                campi.forEach(campo => {
                    localStorage.setItem(`prenotazioni${campo.charAt(0).toUpperCase() + campo.slice(1)}`, JSON.stringify(prenotazioni[campo]));
                    aggiornaCalendario(campo);
                });
                alert("Prenotazioni caricate con successo per tutti i campi!");
            };
            reader.onerror = function() {
                alert("Errore durante la lettura del file CSV!");
            };
            reader.readAsText(file);
        }

        // Salva automaticamente alla chiusura della pagina
        window.addEventListener("beforeunload", function() {
            esportaTuttiCSV();
        });

        // Mostra Campo 1 all'avvio
        mostraCalendario('campo1');
        document.getElementById('btn-campo1').classList.add('campo-attivo');
    </script>
</body>
</html>